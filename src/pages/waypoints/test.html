<html>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript">
        function Point(x, y) {
            this.x = x;
            this.y = y;
        }
        function Day(dayNo){
            this.day = dayNo;
        }
        function Time(time){
            this.time = time;
        }
        function Name(name){
            this.name = name;
        }
        var waypoints = [];
        var days = [];
        var time = [];
        var names = [];
        var color = "#FF0000";
        var img = new Image();
        img.src = "map.jpg";

        $(document).ready(function () {
            var ctx = document.querySelector("canvas").getContext("2d");
            ctx.fillStyle = color;
            ctx.strokeStyle = color + Math.floor((Math.random() * 9) + 1);
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            img.onload = function () {
                ctx.drawImage(img, 0, 0);
            };

            $("#path").contextmenu(function (event) {
                deleteWaypoint(event, document.querySelector("canvas"), ctx);
                draw(document.querySelector("canvas"), ctx);
            });
            $("#path").click(function (event) {
                setWaypoint(event, document.querySelector("canvas"));
                draw(document.querySelector("canvas"), ctx);
            });
            $("#btnSave").click(function(event) {
                getDays();
                getTime();
                getName();
                savePatrol();
            });
            $("#btnLoad").click(function(event) {
                loadPatrol();
            });
        });

        function setWaypoint(e, canvas) {
            var pos = getMousePos(canvas, e);
            waypoints.push(new Point(pos.x, pos.y));
        }

        function deleteWaypoint(e, canvas) {
            var pos = getMousePos(canvas, e);
            var blur = 3;
            waypoints.forEach(function (point) {
                if (Math.abs(pos.x - point.x) < blur || Math.abs(pos.y - point.y) < blur)
                    waypoints.splice(waypoints.indexOf(point), 1);
            });
        }

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        function draw(canvas, ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            ctx.beginPath();
            for (var i = 0; i < waypoints.length; i++) {
                ctx.fillRect(waypoints[i].x, waypoints[i].y, 4, 4);
                ctx.fillText("Waypoint " + i + 1, waypoints[i].x, waypoints[i].y);
                ctx.lineTo(waypoints[i].x, waypoints[i].y);
            }
            ctx.stroke();
            ctx.closePath();
        }
        function savePatrol(){
            //schedule
            //create Days and Time JSON object
            alert("concat: "+JSON.stringify(days.concat(time, names)));
            $.ajax({
                type: "POST",
                url: "localhost:9998/schdule",
                data: JSON.stringify(days.concat(time, names)),
                contentType: "application/json; charset=utf-8",
                //crossDomain: true,
                dataType: "json",
                success: function (data, status, jqXHR) {

                    alert("everything ok!");
                },
                error: function (jqXHR, status) {
                // error handler
                console.log(jqXHR);
                alert("failed: " + status.code);
                }
            });
            //waypoints
            alert("saving: \n"+JSON.stringify(waypoints));
            $.ajax({
                type: "POST",
                url: "localhost:9998/waypoints",
                data: JSON.stringify(waypoints),
                contentType: "application/json; charset=utf-8",
                //crossDomain: true,
                dataType: "json",
                success: function (data, status, jqXHR) {

                    alert("everything ok!");
                },
                error: function (jqXHR, status) {
                // error handler
                console.log(jqXHR);
                alert("failed: " + status.code);
                }
            });
        }

        function loadPatrol(){
            alert("loading:");
             $.ajax({
                type: "GET",
                url: "localhost:9000",
                contentType: "application/json; charset=utf-8",
                //crossDomain: true,
                dataType: "json",
                success: function (data, status, jqXHR) {

                    alert("success");
                },
                error: function (jqXHR, status) {
                    // error handler
                    console.log(jqXHR);
                    alert("failed: " + status.code);
                }
            }).then(function(data){
                alert("data read: "+data.toString());
            });
        }
        function getDays(){
            $("input:checkbox[name=days]:checked").each(function(){
                days.push(new Day($(this).val()));
            });
        }
        function getTime(){
            time.push(new Time(document.getElementById("time").value));
        }
        function getName(){
            names.push(new Name(document.getElementById("name").value));
        }
    </script>
    <head><h1>test</h1></head>
<body id="body" oncontextmenu="return false;">
    <canvas id="path" height="480" width="448" style="position: absolute; z-index: 1;">
    </canvas>
    <canvas id="map" height="480" width="448" style="z-index: 0;">
        <img src="map.jpg">
    </canvas>
    <form id="days">
        <input type="checkbox" name="days" value="0">Mo</input>
        <input type="checkbox" name="days" value="1">Di</input>
        <input type="checkbox" name="days" value="2">Mi</input>
        <input type="checkbox" name="days" value="3">Do</input>
        <input type="checkbox" name="days" value="4">Fr</input>
        <input type="checkbox" name="days" value="5">Sa</input>
        <input type="checkbox" name="days" value="6">So</input>
        <input type="time" id="time"></input>
        <input type="text" id="name" placeholder="Patrol Name"></input>
    </form>
    <button id="btnSave">Save</button>
    <button id="btnLoad">Load</button>
</body>
</html>